from flask import Flask, render_template, request, redirect, url_for, session
import psycopg2
import re


app = Flask(__name__)


app.secret_key = '{{ app_secret_key }}'


@app.route('/')
@app.route('/login', methods =['GET', 'POST'])
def login():
	msg = ''
	if request.method == 'POST' and 'username' in request.form and 'password' in request.form:
		username = request.form['username']
		password = request.form['password']
		conn = psycopg2.connect(database="{{ postgres_db }}", user="{{ postgres_user }}",
        						password="{{ postgres_password }}", host="{{ postgres_server }}", port="{{ postgres_port }}")
		cur = conn.cursor()
		cur.execute('SELECT * FROM accounts WHERE username = %s AND password = md5(%s)', (username, password, ))
		account = cur.fetchone()
		if account:
			session['loggedin'] = True
			session['id'] = account[0]
			session['username'] = account[1]
			msg = 'Pomyślne logowanie!'
			return render_template('index.html', msg = msg)
		else:
			msg = 'Nieprawidłowa nazwa użytkownika/hasło!'
		cur.close()
		conn.close()
	return render_template('login.html', msg = msg)

@app.route('/logout')
def logout():
    session.pop('loggedin', None)
    session.pop('id', None)
    session.pop('username', None)
    return redirect(url_for('login'))

@app.route('/register', methods =['GET', 'POST'])
def register():
	msg = ''
	if request.method == 'POST' and 'username' in request.form and 'password' in request.form and 'email' in request.form and 'address' in request.form and 'city' in request.form and 'country' in request.form and 'postalcode' in request.form and 'organisation' in request.form:
		username = request.form['username']
		password = request.form['password']
		email = request.form['email']
		organisation = request.form['organisation']
		address = request.form['address']
		city = request.form['city']
		state = request.form['state']
		country = request.form['country']
		postalcode = request.form['postalcode']
		conn = psycopg2.connect(database="{{ postgres_db }}", user="{{ postgres_user }}",
        						password="{{ postgres_password }}", host="{{ postgres_server }}", port="{{ postgres_port }}")
		cur = conn.cursor()
		cur.execute('SELECT * FROM accounts WHERE username = %s', (username, ))
		account = cur.fetchone()
		if account:
			msg = 'Takie konto już istnieje!'
		elif not re.match(r'[^@]+@[^@]+\.[^@]+', email):
			msg = 'Nieprawidłowy adres e-mail!'
		elif not re.match(r'[A-Za-z0-9]+', username):
			msg = 'nazwa użytkownika musi posiadać tylko litery i cyfry!'
		else:
			cur.execute('INSERT INTO accounts (username, password, email, organisation, address, city, state, country, postalcode)' 
			   			'VALUES (%s, md5(%s), %s, %s, %s, %s, %s, %s, %s)', 
			   			(username, password, email, organisation, address, city, state, country, postalcode)
						)
			conn.commit()
			cur.close()
			conn.close()
			msg = 'Użytkownik został zarejestrowany!'
	elif request.method == 'POST':
		msg = 'Wypełnij formularz'
	return render_template('register.html', msg = msg)


@app.route("/index")
def index():
	if 'loggedin' in session:
		return render_template("index.html")
	return redirect(url_for('login'))


@app.route("/display")
def display():
	if 'loggedin' in session:
		conn = psycopg2.connect(database="{{ postgres_db }}", user="{{ postgres_user }}",
        						password="{{ postgres_password }}", host="{{ postgres_server }}", port="{{ postgres_port }}")
		cur = conn.cursor()
		cur.execute('SELECT * FROM accounts WHERE id = %s', (session['id'], ))
		account = cur.fetchone()
		cur.close()
		conn.close()
		return render_template("display.html", account = account)
	return redirect(url_for('login'))

@app.route("/update", methods =['GET', 'POST'])
def update():
	msg = ''
	if 'loggedin' in session:
		if request.method == 'POST' and 'username' in request.form and 'password' in request.form and 'email' in request.form and 'address' in request.form and 'city' in request.form and 'country' in request.form and 'postalcode' in request.form and 'organisation' in request.form:
			username = request.form['username']
			password = request.form['password']
			email = request.form['email']
			organisation = request.form['organisation']
			address = request.form['address']
			city = request.form['city']
			state = request.form['state']
			country = request.form['country']
			postalcode = request.form['postalcode']
			conn = psycopg2.connect(database="{{ postgres_db }}", user="{{ postgres_user }}",
        						password="{{ postgres_password }}", host="{{ postgres_server }}", port="{{ postgres_port }}")
			cur = conn.cursor()
			cur.execute('SELECT * FROM accounts WHERE username = %s', (username, ))
			account = cur.fetchone()
			if not account:
				msg = 'Nie ma takiego konta!'
			elif not re.match(r'[^@]+@[^@]+\.[^@]+', email):
				msg = 'Nieprawidłowy adres e-mail!'
			elif not re.match(r'[A-Za-z0-9]+', username):
				msg = 'nazwa użytkownika musi posiadać tylko litery i cyfry!'
			else:
				cur.execute('UPDATE accounts SET username =%s, password =md5(%s), email =%s, organisation =%s, address =%s, city =%s, state =%s, country =%s, postalcode =%s WHERE id =%s', (username, password, email, organisation, address, city, state, country, postalcode, (session['id'], ), ))
				conn.commit()
				cur.close()
				conn.close()
				msg = 'Dane użytkownika zaktuzalizowane pomyślnie!'
		elif request.method == 'POST':
			msg = 'Wypełnij formularz'
		return render_template("update.html", msg = msg)
	return redirect(url_for('login'))

if __name__ == "__main__":
	app.run(host ="0.0.0.0", port = int("5000"))
